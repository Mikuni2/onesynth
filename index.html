<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneSynth — Síntese Profissional de Reviews</title>

  <style>
    :root{
      --bg:#f3f5f8;
      --card:#ffffff;
      --ink:#1f2a37;
      --muted:#6b7280;
      --line:#e5e7eb;

      --blue:#1f4b7a;
      --blue-2:#2d5f93;

      --green:#2f7d63;
      --green-soft:#e8f4ef;

      --orange:#b26a0a;
      --orange-soft:#fff4e2;

      --red:#a33a2b;
      --red-soft:#fdecec;

      --slate:#4b5563;
      --slate-soft:#eef2f7;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    .page{
      max-width: 920px;
      margin: 24px auto;
      padding: 0 16px;
    }

    /* TOP BRAND */
    .brand{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 6px 20px rgba(15,23,42,.06);
    }

    .brandTop{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 18px 18px 10px;
    }

    .logoMark{
      width:40px; height:40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #29b6f6, #7c3aed 55%, #f59e0b);
      position:relative;
      flex:0 0 auto;
    }
    .logoMark::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: 8px;
      background: rgba(255,255,255,.85);
      clip-path: polygon(0 70%, 70% 0, 100% 30%, 30% 100%);
    }

    .logoText{
      font-weight: 800;
      font-size: 28px;
      letter-spacing: .2px;
    }

    .titleBar{
      background: linear-gradient(180deg, var(--blue), #163a5e);
      color:#fff;
      padding: 12px 18px;
      font-weight: 700;
      border-top: 1px solid rgba(255,255,255,.08);
    }

    /* INPUT CARD */
    .inputCard{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      margin-top: 16px;
      padding: 18px;
      box-shadow: 0 6px 20px rgba(15,23,42,.06);
    }

    label{ display:block; font-weight:700; margin: 10px 0 8px; }
    input{
      width:100%;
      padding: 12px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    input:focus{ border-color:#9ca3af; box-shadow: 0 0 0 3px rgba(59,130,246,.12); }

    .btn{
      width:100%;
      margin-top: 12px;
      padding: 12px 14px;
      border: 0;
      border-radius: 10px;
      background: #3aa166;
      color:#fff;
      font-weight: 800;
      cursor:pointer;
      font-size: 14px;
    }
    .btn:hover{ filter: brightness(.97); }
    .btn:disabled{ background:#9ca3af; cursor:not-allowed; }

    .hint{
      margin-top: 10px;
      background: #e7f3ff;
      color:#1d4ed8;
      border: 1px solid rgba(29,78,216,.15);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
    }

    /* RESULT WRAPPER */
    .resultWrap{
      margin-top: 16px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 6px 20px rgba(15,23,42,.06);
    }

    .section{
      padding: 16px 18px;
      border-top: 1px solid var(--line);
    }
    .section:first-child{ border-top:0; }

    .metaGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      background: #f7fafc;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    .metaRow{
      display:flex;
      gap: 10px;
      padding: 6px 8px;
      border-bottom: 1px solid rgba(229,231,235,.7);
    }
    .metaRow:last-child{ border-bottom:0; }
    .metaKey{ width: 160px; color:#0f172a; font-weight:800; }
    .metaVal{ color:#111827; flex:1; }

    .panel{
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow:hidden;
      background: #fff;
    }
    .panelHead{
      padding: 10px 12px;
      font-weight: 800;
      color:#fff;
      font-size: 14px;
    }
    .panelBody{
      padding: 12px;
      background: #fff;
      color:#111827;
    }

    .panel.green .panelHead{ background: var(--green); }
    .panel.green .panelBody{ background: var(--green-soft); }

    .panel.orange .panelHead{ background: var(--orange); }
    .panel.orange .panelBody{ background: var(--orange-soft); }

    .panel.red .panelHead{ background: var(--red); }
    .panel.red .panelBody{ background: var(--red-soft); }

    .panel.slate .panelHead{ background: var(--slate); }
    .panel.slate .panelBody{ background: var(--slate-soft); }

    .cols2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      .cols2{ grid-template-columns: 1fr 1fr; }
    }

    ul{ margin: 0; padding-left: 18px; }
    li{ margin: 6px 0; }
    .muted{ color: var(--muted); font-size: 12px; }

    .loading{
      padding: 18px;
      color: var(--muted);
      font-style: italic;
    }

    .errorBox{
      margin: 16px 18px;
      border-radius: 12px;
      border: 1px solid rgba(220,38,38,.22);
      background: #fee;
      color:#991b1b;
      padding: 12px 12px;
    }
    .errorBox small{ color:#7f1d1d; }

    /* Make the final output look like your reference image */
    .reportShell{
      padding: 16px 18px 18px;
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- BRAND / HEADER -->
    <div class="brand">
      <div class="brandTop">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="logoText">OneSynth</div>
      </div>
      <div class="titleBar">Síntese Profissional de Reviews • Apoio à Recomendação Hoteleira</div>
    </div>

    <!-- INPUT -->
    <div class="inputCard">
      <div class="hint">ℹ️ Sistema otimizado: 5 reviews por análise (mais rápido e económico)</div>

      <label for="hotelName">Nome do Hotel, Cidade:</label>
      <input id="hotelName" type="text" placeholder="Ex: Hotel Pestana CR7, Funchal" />

      <button class="btn" id="btnAnalisar" onclick="analisar()">Gerar Conclusão</button>

      <div id="error"></div>
    </div>

    <!-- RESULT -->
    <div class="resultWrap" id="resultWrap" style="display:none;">
      <div class="reportShell" id="result"></div>
      <div class="section">
        <div class="muted" id="metaFooter"></div>
      </div>
    </div>

  </div>

  <script>
    // ---------- Small helpers ----------
    function esc(s){
      return (s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalize(s){
      return (s || "").toLowerCase().replace(/\s+/g," ").trim();
    }

    function sectionBetween(text, title){
      // finds content after a title until the next known title
      const titles = [
        "Identificação",
        "Avaliação global de adequação",
        "Pontos fortes recorrentes",
        "Pontos fracos recorrentes",
        "Aspetos dependentes do perfil do cliente",
        "Recomendado para",
        "Não recomendado se o cliente",
        "Não recomendado se o Cliente",
        "Alertas pontuais",
        "Nota metodológica"
      ];

      const t = title;
      const idx = text.toLowerCase().indexOf(t.toLowerCase());
      if (idx === -1) return "";

      // start after the title line
      const after = text.slice(idx);
      const firstBreak = after.indexOf("\n");
      const start = idx + (firstBreak === -1 ? after.length : firstBreak + 1);

      // find next title occurrence
      let end = text.length;
      for (const nt of titles){
        if (normalize(nt) === normalize(t)) continue;
        const j = text.toLowerCase().indexOf(nt.toLowerCase(), start);
        if (j !== -1 && j < end) end = j;
      }
      return text.slice(start, end).trim();
    }

    function parseList(block){
      if (!block) return [];
      const lines = block.split("\n").map(l => l.trim()).filter(Boolean);

      // keep only list-like lines; fallback: if none, return first paragraph as single item
      const items = [];
      for (const l of lines){
        const m = l.match(/^(\-|\*|•|–|\u2022)\s+(.*)$/);
        if (m) items.push(m[2].trim());
        else if (/^\d+[\.\)]\s+/.test(l)) items.push(l.replace(/^\d+[\.\)]\s+/,"").trim());
      }

      if (items.length) return items;

      // fallback: split by sentences if it is a paragraph
      const compact = lines.join(" ").trim();
      if (!compact) return [];
      return [compact];
    }

    function pickLineValue(block, key){
      const lines = (block || "").split("\n").map(l=>l.trim()).filter(Boolean);
      for (const l of lines){
        // supports "Hotel: X" or "- Hotel: X"
        const cleaned = l.replace(/^\-\s*/,"");
        if (cleaned.toLowerCase().startsWith(key.toLowerCase()+":")){
          return cleaned.split(":").slice(1).join(":").trim();
        }
      }
      return "";
    }

    function findRiskFromAdequacy(block){
      // try to find something like "principal risco" in adequacy block
      const b = block || "";
      const m = b.match(/principal\s+risco[^:]*:\s*(.+)$/im);
      if (m) return m[1].trim();
      // fallback: if the block contains "risco", return sentence containing it
      const s = b.split(/[\.\n]/).map(x=>x.trim()).filter(Boolean);
      const r = s.find(x => x.toLowerCase().includes("risco"));
      return r ? r : "";
    }

    function buildUL(items){
      if (!items || !items.length) return "<div class='muted'>Sem dados suficientes nas reviews fornecidas.</div>";
      return "<ul>" + items.map(i => "<li>"+esc(i)+"</li>").join("") + "</ul>";
    }

    // ---------- Main render ----------
    function renderReport(markdown, meta){
      // Remove the main title line if present
      const text = (markdown || "").replace(/\r\n/g,"\n").trim();

      const ident = sectionBetween(text, "Identificação");
      const adequacy = sectionBetween(text, "Avaliação global de adequação");
      const strengths = sectionBetween(text, "Pontos fortes recorrentes");
      const weaknesses = sectionBetween(text, "Pontos fracos recorrentes");
      const notRec1 = sectionBetween(text, "Não recomendado se o cliente");
      const notRec2 = sectionBetween(text, "Não recomendado se o Cliente");
      const notRec = notRec1 || notRec2;
      const alerts = sectionBetween(text, "Alertas pontuais");
      const note = sectionBetween(text, "Nota metodológica");

      const hotel = pickLineValue(ident, "Hotel") || meta?.hotel_name || "";
      const location = pickLineValue(ident, "Localização") || meta?.location || "";
      const source = pickLineValue(ident, "Fonte das opiniões") || meta?.data_source || "Reviews públicas";
      const volume = pickLineValue(ident, "Volume analisado") || (meta?.estimated_reviews ? `~${meta.estimated_reviews} reviews` : "");

      const risk = findRiskFromAdequacy(adequacy);

      const strengthsList = parseList(strengths);
      const weaknessesList = parseList(weaknesses);
      const notRecList = parseList(notRec);
      const alertsList = parseList(alerts);

      // Adequacy text: keep 2–3 lines feel, but don't over-edit content
      const adequacyText = (adequacy || "").split("\n").map(l=>l.trim()).filter(Boolean).join(" ");

      const noteText = (note || "").trim();

      return `
        <div class="panel slate" style="margin-bottom:12px;">
          <div class="panelBody">
            <div class="metaGrid">
              <div class="metaRow"><div class="metaKey">Hotel:</div><div class="metaVal">${esc(hotel)}</div></div>
              <div class="metaRow"><div class="metaKey">Localização:</div><div class="metaVal">${esc(location)}</div></div>
              <div class="metaRow"><div class="metaKey">Fonte das opiniões:</div><div class="metaVal">${esc(source)}</div></div>
              <div class="metaRow"><div class="metaKey">Volume analisado:</div><div class="metaVal">${esc(volume)}</div></div>
            </div>
          </div>
        </div>

        <div class="panel green" style="margin-bottom:12px;">
          <div class="panelHead">Avaliação global de adequação</div>
          <div class="panelBody">
            <div style="font-weight:700; margin-bottom:8px;">${esc(adequacyText || "Sem dados suficientes para uma avaliação global sólida com o volume analisado.")}</div>
            ${risk ? `<div style="margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid rgba(17,24,39,.12); background: rgba(255,255,255,.55);">
              <span style="font-weight:900;">⚠️ Principal risco identificado:</span> ${esc(risk)}
            </div>` : ""}
          </div>
        </div>

        <div class="panel green" style="margin-bottom:12px;">
          <div class="panelHead">Pontos fortes recorrentes (padrões consistentes)</div>
          <div class="panelBody">${buildUL(strengthsList)}</div>
        </div>

        <div class="cols2" style="margin-bottom:12px;">
          <div class="panel orange">
            <div class="panelHead">Pontos fracos recorrentes</div>
            <div class="panelBody">${buildUL(weaknessesList)}</div>
          </div>
          <div class="panel red">
            <div class="panelHead">Não recomendado se o Cliente:</div>
            <div class="panelBody">${buildUL(notRecList)}</div>
          </div>
        </div>

        <div class="cols2">
          <div class="panel orange">
            <div class="panelHead">Alertas pontuais</div>
            <div class="panelBody">${buildUL(alertsList)}</div>
          </div>
          <div class="panel slate">
            <div class="panelHead">Nota metodológica</div>
            <div class="panelBody">
              ${noteText ? `<div>${esc(noteText)}</div>` : `<div>${esc("Esta síntese baseia-se exclusivamente na análise de padrões recorrentes em opiniões públicas de hóspedes, com o objetivo de apoiar a recomendação profissional e alinhar expectativas do cliente.")}</div>`}
            </div>
          </div>
        </div>
      `;
    }

    // ---------- Fetch ----------
    async function analisar(){
      const hotelName = document.getElementById("hotelName").value.trim();
      const btn = document.getElementById("btnAnalisar");
      const errorDiv = document.getElementById("error");
      const resultWrap = document.getElementById("resultWrap");
      const resultDiv = document.getElementById("result");
      const metaFooter = document.getElementById("metaFooter");

      errorDiv.innerHTML = "";
      resultWrap.style.display = "none";
      resultDiv.innerHTML = "";

      if (!hotelName){
        errorDiv.innerHTML = `<div class="errorBox">❌ Por favor, insere o nome do hotel.</div>`;
        return;
      }

      btn.disabled = true;
      btn.textContent = "A analisar…";
      resultWrap.style.display = "block";
      resultDiv.innerHTML = `<div class="loading">⏳ A processar… Aguarda 20–30 segundos…</div>`;
      metaFooter.textContent = "";

      try{
        const response = await fetch(fetch("https://onesynth.onrender.com/analyze-api", {
          ,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ hotel_name: hotelName })
        });

        if (!response.ok){
          let detail = "Erro ao processar";
          try{
            const err = await response.json();
            detail = err.detail || detail;
          }catch(_){}
          throw new Error(detail);
        }

        const data = await response.json();

        // Render the pretty layout (content stays the same, only presentation changes)
        resultDiv.innerHTML = renderReport(data.result_markdown, {
          hotel_name: hotelName,
          data_source: data?.meta?.data_source,
          estimated_reviews: data?.meta?.estimated_reviews,
          google_rating: data?.meta?.google_rating,
          total_ratings: data?.meta?.total_ratings
        });

        // Footer meta
        const parts = [];
        if (data?.meta?.data_source) parts.push(data.meta.data_source);
        if (data?.meta?.estimated_reviews) parts.push(`${data.meta.estimated_reviews} reviews analisadas`);
        if (data?.meta?.google_rating) parts.push(`Rating: ${data.meta.google_rating}/5 (${data.meta.total_ratings} avaliações totais)`);
        metaFooter.textContent = parts.join(" • ");

      }catch(err){
        errorDiv.innerHTML = `
          <div class="errorBox">
            ❌ <strong>Erro:</strong> ${esc(err.message)}
            <br><br>
            <small>Verifica se o backend está a correr em https://onesynth.onrender.com </small>
          </div>
        `;
        resultDiv.innerHTML = "";
        resultWrap.style.display = "none";
      }finally{
        btn.disabled = false;
        btn.textContent = "Gerar Conclusão";
      }
    }

    document.getElementById("hotelName").addEventListener("keypress", (e)=>{
      if (e.key === "Enter") analisar();
    });
  </script>
</body>
</html>
